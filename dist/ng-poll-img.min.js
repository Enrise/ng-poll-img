/**
 * @title ng-poll-img.js
 * @description An AngularJS directive which polls the server for an image and shows a fallback until it's available.
 * @author Rick Kuipers <rskuipers@enrise.com>
 * @version 2.0.0
 *
 * @example <poll-img source="http://example.com/2Fd1aZs.jpg" class="img-responsive" fallback="http://placehold.it/1216x400" on-success="success()"></poll-img>
 */
angular.module("ngPollImg",[]).directive("pollImg",["$http","$timeout","pollImgService",function(e,n,i){return{restrict:"E",replace:!0,template:"<img ng-src=\"{{ currentSource }}\" ng-class=\"{'ng-poll-img-loaded': imageLoaded, 'ng-poll-img-given-up': givenUp}\" />",scope:{source:"@",fallback:"@",currentSource:"@",giveUpAfter:"@",onSuccess:"&?",onGivingUp:"&?"},link:function(e){i.addImage(e.source,function(){e.currentSource=e.source,e.imageLoaded=!0,e.onSuccess&&e.onSuccess()},function(){e.currentSource=e.fallback},e.giveUpAfter,function(){e.givenUp=!0,e.onGivingUp()})}}}]).factory("pollImgService",["$http","$interval","ngPollImgConfig",function(e,n,i){var l={};return l.pollingImages={},l.pollInterval=null,l.addImage=function(e,r,o,t,a){return angular.isDefined(l.pollingImages[e])||(l.pollingImages[e]={success:[],error:[],giveUp:[],giveUpAfter:t,tries:0,state:"PENDING"}),"SUCCESS"==l.pollingImages[e].state?void r():(l.pollingImages[e].success.push(r),l.pollingImages[e].error.push(o),l.pollingImages[e].giveUp.push(a),l.pollImage(e,l.pollingImages[e]),void(l.pollInterval||(l.pollInterval=n(l.pollImages,i.interval))))},l.pollImage=function(n,i){"PENDING"===i.state&&(i.tries++,e.get(n).success(function(){angular.forEach(i.success,function(e){e()}),l.finishImage(i,"SUCCESS")}).error(function(){if(angular.forEach(i.error,function(e){e()}),i.state="PENDING",i.giveUpAfter>0&&i.tries>=i.giveUpAfter){var e=i.giveUp;l.finishImage(i,"GIVEN_UP"),angular.forEach(e,function(e){e()})}}),i.state="POLLING")},l.pollImages=function(){var e=!1;angular.forEach(l.pollingImages,function(n,i){"SUCCESS"!=n.state&&(e=!0,l.pollImage(i,n))}),e||n.cancel(l.pollInterval)},l.finishImage=function(e,n){e.state=n,e.success=[],e.error=[],e.giveUp=[]},l}]).provider("ngPollImgConfig",function(){this.interval=3e3,this.$get=function(){return{interval:this.interval}}});