/**
 * @title ng-poll-img.js
 * @description An AngularJS directive which polls the server for an image and shows a fallback until it's available.
 * @author Rick Kuipers <rskuipers@enrise.com>
 * @version 1.0.0
 *
 * @example <poll-img source="http://example.com/2Fd1aZs.jpg" class="img-responsive" fallback="http://placehold.it/1216x400" on-success="success()"></poll-img>
 */
angular.module("ngPollImg",[]).directive("pollImg",["$http","$timeout","pollImgService",function(e,n,l){return{restrict:"E",replace:!0,template:"<img ng-src=\"{{ currentSource }}\" ng-class=\"{'ng-poll-img-loaded': imageLoaded, 'ng-poll-img-given-up': givenUp}\" />",scope:{source:"@",fallback:"@",currentSource:"@",giveUpAfter:"@",onSuccess:"&?",onGivingUp:"&?"},link:function(e){l.addImage(e.source,function(){e.currentSource=e.source,e.imageLoaded=!0,e.onSuccess&&e.onSuccess()},function(){e.currentSource=e.fallback},e.giveUpAfter,function(){e.givenUp=!0,e.onGivingUp()})}}}]).factory("pollImgService",["$http","$interval","ngPollImgConfig",function(e,n,l){var i={};return i.pollingImages={},i.pollInterval=null,i.addImage=function(e,o,r,t,g){return angular.isDefined(i.pollingImages[e])||(i.pollingImages[e]={success:[],error:[],giveUp:[],giveUpAfter:t,tries:0,state:"PENDING"}),"SUCCESS"==i.pollingImages[e].state?void o():(i.pollingImages[e].success.push(o),i.pollingImages[e].error.push(r),i.pollingImages[e].giveUp.push(g),i.pollImage(e,i.pollingImages[e]),void(i.pollInterval||(i.pollInterval=n(i.pollImages,l.interval))))},i.pollImage=function(n,l){"PENDING"===l.state&&(l.tries++,e.get(n).success(function(){angular.forEach(l.success,function(e){e()}),i.finishImage(l,"SUCCESS")}).error(function(){angular.forEach(l.error,function(e){e()}),l.state="PENDING",l.giveUpAfter>0&&l.tries>=l.giveUpAfter&&(i.finishImage(l,"GIVEN_UP"),angular.forEach(l.giveUp,function(e){e()}))}),l.state="POLLING")},i.pollImages=function(){var e=!1;angular.forEach(i.pollingImages,function(n,l){"SUCCESS"!=n.state&&(e=!0,i.pollImage(l,n))}),e||n.cancel(i.pollInterval)},i.finishImage=function(e,n){e.state=n,e.success=[],e.error=[],e.giveUp=[]},i}]).provider("ngPollImgConfig",function(){this.interval=3e3,this.$get=function(){return{interval:this.interval}}});